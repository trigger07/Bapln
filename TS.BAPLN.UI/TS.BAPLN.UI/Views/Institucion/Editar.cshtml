@*@model TS.BAPLN.DataEntities.DTO.InstitucionFullDTO*@

@model TS.BAPLN.UI.Models.InstitucionViewModel
@{
    Html.EnableClientValidation(false);
    ViewBag.Title = "Editar Registro de Institución";
}

<h1 class="page-header"><small>Editar Información de</small> Institución</h1>

@using (Html.BeginForm("Editar", "Institucion", FormMethod.Post, new {@id = "frmInstitucion"}))
{
    @Html.AntiForgeryToken()
    <input type="hidden" name="myHiddenInput" id="myHiddenInput" value="@ViewBag.InstitucionId" />
    <div id="content" class="content">
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-inverse">
                    <div class="panel-heading">
                        <div class="panel-heading-btn">
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-default" data-click="panel-expand"><i class="fa fa-expand"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-success" data-click="panel-reload"><i class="fa fa-repeat"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-warning" data-click="panel-collapse"><i class="fa fa-minus"></i></a>
                            <a href="javascript:;" class="btn btn-xs btn-icon btn-circle btn-danger" data-click="panel-remove"><i class="fa fa-times"></i></a>
                        </div>
                        <h4 class="panel-title">Formulario de datos</h4>
                    </div>
                    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                    <div class="panel-body">
                        <form class="form-horizontal">
                            <div class="row">
                                @*Formulario Datos*@
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Nombre:</label>
                                        <input class="form-control text-box single-line" id="txtNombre" name="Institucion.Nombre" type="text" value="@Model.Institucion.Nombre">
                                        <ul id="nombreErrores" class="parsley-errors-list"></ul>
                                    </div>

                                    <div class="form-group">
                                        <label class="control-label">Teléfono:</label>
                                        <input class="form-control text-box single-line" id="txtTelefono" name="Institucion.Telefono" type="text" value="@Model.Institucion.Telefono">
                                    </div>

                                    <div class="form-group" style="min-height:60px !important;">
                                        <label class="control-label">Dirección:</label>
                                        <textarea class="form-control" placeholder="Textarea" rows="3" id="txtDireccion" name="Institucion.Direccion">@Model.Institucion.Direccion</textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="control-label">Email Contact:</label>
                                        <input class="form-control text-box single-line" id="txtEmailContacto" name="Institucion.EmailContacto" type="text" value="@Model.Institucion.EmailContacto">
                                    </div>

                                    <div class="form-group">
                                        <label class="control-label">Website:</label>
                                        <input class="form-control text-box single-line" id="txtWebsite" name="Institucion.Website" type="text" value="@Model.Institucion.Website">
                                    </div>
                                </div>

                                @*Catálogos*@
                                <div class="col-md-6">
                                    <div class="panel-group" id="accordion">
                                        <div class="panel panel-inverse @*overflow-hidden*@">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">
                                                    <a class="accordion-toggle accordion-toggle-styled" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false">
                                                        <i class="fa fa-plus-circle pull-right"></i>
                                                        Materias
                                                    </a>
                                                </h3>
                                            </div>
                                            <div id="collapseOne" class="panel-collapse collapse in">
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-9">
                                                            <a class="editable editable-click" href="#" id="MateriasSeleccionadas" name="MateriasSeleccionadas" data-type="checklist" data-value="@Model.MateriasSeleccionadas" data-title="Seleccione materias" value="@Model.MateriasSeleccionadas">
                                                                @foreach (var materia in Model.Materias)
                                                                {
                                                                    @materia.Descripcion<br>
                                                                }
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="panel panel-inverse @*overflow-hidden*@">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">
                                                    <a class="accordion-toggle accordion-toggle-styled collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false">
                                                        <i class="fa fa-plus-circle pull-right"></i>
                                                        Niveles
                                                    </a>
                                                </h3>
                                            </div>
                                            <div id="collapseTwo" class="panel-collapse collapse">
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-9">
                                                            <a class="editable editable-click" href="#" id="NivelesSeleccionados" name="NivelesSeleccionados" data-type="checklist" data-value="@Model.NivelesSeleccionados" data-title="Seleccione Niveles">
                                                                @foreach (var nivel in Model.Niveles)
                                                                {
                                                                    @nivel.Descripcion<br>
                                                                }
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="panel panel-inverse @*overflow-hidden*@">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">
                                                    <a class="accordion-toggle accordion-toggle-styled collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false">
                                                        <i class="fa fa-plus-circle pull-right"></i>
                                                        Períodos
                                                    </a>
                                                </h3>
                                            </div>
                                            <div id="collapseThree" class="panel-collapse collapse">
                                                <div class="panel-body">
                                                    <div class="row">
                                                        <div class="col-md-9">
                                                            <a class="editable editable-click" href="#" id="PeriodosSeleccionados" name="PeriodosSeleccionados" data-type="checklist" data-value="@Model.PeriodosSeleccionados" data-title="Seleccione períodos">
                                                                @foreach (var periodo in Model.Periodos)
                                                                {
                                                                    @periodo.Descripcion<br>
                                                                }
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-12 text-right">
                                    <button type="submit" class="btn btn-sm btn-success">Guardar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="modal fade" id="modal-dialog" style="display: none;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h4 class="modal-title">Editar Lista de Materias</h4>
                        </div>
                        <div class="modal-body">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="">
                                    Español                                    
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="">
                                    Matemáticas
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="">
                                    Ciencias Naturales
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="">
                                    Biología                                    
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="">
                                    Química
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="">
                                    Fisica Matemática
                                </label>
                            </div>
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" value="">
                                    Estudios Sociales
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="javascript:;" class="btn btn-sm btn-white" data-dismiss="modal">Cerrar</a>
                            <a href="javascript:;" class="btn btn-sm btn-success">Salvar</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}

<style>
    .editable-popup {
        z-index:2000!important;
    }

    .editable-click, a.editable-click, a.editable-click:hover {
        text-decoration: none;
        border-bottom:none !important;
    }
</style>

<script type="text/javascript">
    var jsonDtoMaterias;
    var jsonDtoPeriodos;
    var jsonDtoNiveles;

    jQuery(document).ready(function () {

        $("#frmInstitucion").submit(function (e) {
            e.preventDefault();

            $('#nombreErrores li').remove();
            if ($('#txtNombre').val() == '') {
                $('#nombreErrores').append('<li class="parsley-required">El campo Nombre es requerido.</li>');
            }
            else {
                var materias = $('#MateriasSeleccionadas').editable('getValue');
                var periodos = $('#PeriodosSeleccionados').editable('getValue');
                var niveles = $('#NivelesSeleccionados').editable('getValue');

                var formData = $(this).serializeArray();
                formData.push({ name: "MateriasSeleccionadas", value: materias.MateriasSeleccionadas.toString() });
                formData.push({ name: "PeriodosSeleccionados", value: periodos.PeriodosSeleccionados.toString() });
                formData.push({ name: "NivelesSeleccionados", value: niveles.NivelesSeleccionados.toString() });

                if (!formData["id"]) {
                    // Does not exist
                    formData.push({ name: "id", value: $('#myHiddenInput').val() });
                }

                $.ajax({
                    type: $(this).attr('method'),
                    url: $(this).attr('action'),
                    data: formData,
                    success: function (response) {
                        if (response.Result === "success") {
                            //mostrar modal de success
                            //$.gritter.add({
                            //    // (string | mandatory) the heading of the notification
                            //    title: 'Excelente!',
                            //    // (string | mandatory) the text inside the notification
                            //    text: 'Sus cambios han sido guardados exitosamente.',                                
                            //    // (bool | optional) if you want it to fade out on its own or just sit there
                            //    sticky: false,
                            //    // (int | optional) the time you want it to be alive for before fading out
                            //    time: '2400',
                            //    class_name: 'gritter-light'
                            //});
                            window.location = "/Institucion/Instituciones";
                        }
                        else if (response.Result === "duplicate") {
                            $('#nombreErrores').append('<li class="parsley-required">Ya existe una institución con este nombre.</li>');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        debugger;
                    }
                });
            }
        });

        $('#MateriasSeleccionadas').editable({
            type: 'checklist',
            placement: 'bottom',
            emptytext: '[Editar lista de Materias]',
            source: function () {
                var result;
                if (jsonDtoMaterias == null || jsonDtoMaterias.length == 0) {
                    $.ajax({
                        url: window.location.origin + '/Institucion/ObtenerCatalogoMaterias',
                        type: 'GET',
                        global: false,
                        async: false,
                        success: function (data) {
                            if (data.length > 0) {
                                jsonDtoMaterias = new Array();
                                var item;
                                $.each(data, function (k, v) {
                                    item = { value: v.Id, text: v.Descripcion };
                                    jsonDtoMaterias.push(item);
                                });
                            }
                            result = jsonDtoMaterias;
                        }
                    });
                    return result;
                }
                else {
                    return jsonDtoMaterias;
                }
            },
            sourceError: 'Oops! Error.'
        });

        $('#PeriodosSeleccionados').editable({
            type: 'checklist',
            placement: 'bottom',
            emptytext: '[Editar lista de Períodos]',
            source: function () {
                var result;
                if (jsonDtoPeriodos == null || jsonDtoPeriodos.length == 0) {
                    $.ajax({
                        url: window.location.origin + '/Institucion/ObtenerCatalogoPeriodos',
                        type: 'GET',
                        global: false,
                        async: false,
                        success: function (data) {
                            if (data.length > 0) {
                                jsonDtoPeriodos = new Array();
                                var item;
                                $.each(data, function (k, v) {
                                    item = { value: v.Id, text: v.Descripcion };
                                    jsonDtoPeriodos.push(item);
                                });
                            }
                            result = jsonDtoPeriodos;
                        }
                    });
                    return result;
                }
                else {
                    return jsonDtoPeriodos;
                }
            },
            sourceError: 'Oops! Error.'
        });

        $('#NivelesSeleccionados').editable({
            type: 'checklist',
            placement: 'bottom',
            emptytext: '[Editar lista de Niveles]',
            source: function () {
                var result;
                if (jsonDtoNiveles == null || jsonDtoNiveles.length == 0) {
                    $.ajax({
                        url: window.location.origin + '/Institucion/ObtenerCatalogoNiveles',
                        type: 'GET',
                        global: false,
                        async: false,
                        success: function (data) {
                            if (data.length > 0) {
                                jsonDtoNiveles = new Array();
                                var item;
                                $.each(data, function (k, v) {
                                    item = { value: v.Id, text: v.Descripcion };
                                    jsonDtoNiveles.push(item);
                                });
                            }
                            result = jsonDtoNiveles;
                        }
                    });
                    return result;
                }
                else {
                    return jsonDtoNiveles;
                }
            },
            sourceError: 'Oops! Error.'
        });
    });
</script>

